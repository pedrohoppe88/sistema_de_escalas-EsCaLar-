<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Estat√≠sticas de Servi√ßos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">

<h2>üìä Estat√≠sticas de Servi√ßos</h2>
<p>Veja quem est√° tirando mais servi√ßo no per√≠odo selecionado.</p>

<form method="get" class="mb-3">
    <div class="row g-2 align-items-end">
        <div class="col-md-3">
            <label class="form-label">In√≠cio</label>
            <input type="date" name="inicio" class="form-control" value="{{ inicio|date:'Y-m-d' }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">Fim</label>
            <input type="date" name="fim" class="form-control" value="{{ fim|date:'Y-m-d' }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">Pesquisar por nome</label>
            <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Ex.: Jo√£o">
        </div>
        <div class="col-md-3">
            <label class="form-label">Gradua√ß√£o</label>
            <select name="graduacao" class="form-select">
                <option value="">Todas</option>
                {% for code,label in graduacoes %}
                    <option value="{{ code }}" {% if graduacao == code %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Subunidade</label>
            <select name="subunidade" class="form-select">
                <option value="">Todas</option>
                {% for su in subunidades %}
                    <option value="{{ su }}" {% if subunidade == su %}selected{% endif %}>{{ su }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3 d-flex gap-2">
            <button type="submit" class="btn btn-outline-primary w-50">Filtrar</button>
            <a href="{% url 'estatisticas_servico' %}" class="btn btn-outline-secondary w-50">Limpar</a>
        </div>
    </div>
</form>

<div class="row mb-4">
    <div class="col-lg-6 mb-3">
        <div class="card">
            <div class="card-header">
                <strong>Top 10 por Total de Servi√ßos</strong>
            </div>
            <div class="card-body">
                <canvas id="chartTop" height="160"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-3">
        <div class="card">
            <div class="card-header">
                <strong>Distribui√ß√£o por Tipo (Per√≠odo)</strong>
            </div>
            <div class="card-body">
                <canvas id="chartTipos" height="160"></canvas>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        const topLabels = [
            {% for row in stats|slice:":10" %}
                "{{ row.militar.nome|escapejs }}"{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        const topValues = [
            {% for row in stats|slice:":10" %}
                {{ row.total }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        const ctxTop = document.getElementById('chartTop');
        if (ctxTop) {
            new Chart(ctxTop, {
                type: 'bar',
                data: {
                    labels: topLabels,
                    datasets: [{
                        label: 'Total de servi√ßos',
                        data: topValues,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13,110,253,0.25)',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { autoSkip: false, maxRotation: 60, minRotation: 0 } },
                        y: { beginAtZero: true, precision: 0 }
                    }
                }
            });
        }

        const tipoLabels = [
            {% for lbl in tipo_labels %}
                "{{ lbl|escapejs }}"{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        const tipoValues = [
            {% for val in tipo_values %}
                {{ val }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        const ctxTipos = document.getElementById('chartTipos');
        if (ctxTipos) {
            new Chart(ctxTipos, {
                type: 'doughnut',
                data: {
                    labels: tipoLabels,
                    datasets: [{
                        label: 'Quantidade',
                        data: tipoValues,
                        backgroundColor: [
                            '#0d6efd','#6610f2','#6f42c1','#d63384','#dc3545',
                            '#fd7e14','#ffc107','#198754'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
    </script>
</div>

<div class="table-responsive">
    <table class="table table-bordered table-striped align-middle">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Nome</th>
                <th>Gradua√ß√£o</th>
                <th>Subunidade</th>
                <th class="text-center">Total</th>
                <th class="text-center">Guarda</th>
                <th class="text-center">Plant√£o</th>
                <th class="text-center">Perman√™ncia</th>
                <th class="text-center">Cmd Guarda</th>
                <th class="text-center">Cabo Guarda</th>
                <th class="text-center">Cabo de Dia</th>
                <th class="text-center">Adjunto</th>
                <th class="text-center">Oficial de Dia</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% if stats %}
                {% for row in stats %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ row.militar.nome }}</td>
                        <td>{{ row.graduacao }}</td>
                        <td>{{ row.subunidade }}</td>
                        <td class="text-center"><span class="badge bg-primary">{{ row.total }}</span></td>
                        <td class="text-center">{{ row.guarda }}</td>
                        <td class="text-center">{{ row.plantao }}</td>
                        <td class="text-center">{{ row.permanencia }}</td>
                        <td class="text-center">{{ row.comandante_guarda }}</td>
                        <td class="text-center">{{ row.cabo_guarda }}</td>
                        <td class="text-center">{{ row.cabo_dia }}</td>
                        <td class="text-center">{{ row.adjunto }}</td>
                        <td class="text-center">{{ row.oficial_dia }}</td>
                        <td>
                            <a href="{% url 'historico_militar' row.militar.id %}" class="btn btn-sm btn-outline-secondary">Hist√≥rico</a>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="14" class="text-center">Nenhum servi√ßo encontrado no per√≠odo.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
    <p class="text-muted">Per√≠odo: {{ inicio|date:"d/m/Y" }} a {{ fim|date:"d/m/Y" }}</p>
    <a href="{% url 'dashboard' %}" class="btn btn-secondary">‚Ü© Voltar</a>
</div>

</body>
</html>
